## h4 Tiedustelua

Tehtävien lähde: https://terokarvinen.com/2021/penetration-testing-course-2022-spring/#comments kohta h4.

Kali linuxin kanssa oli hieman haasteita. Annoin lisää muistia ja painoin virtual boxista reset nappia. Kun sain kalin taas toimimaan, varmistin että se ei pääse yhdistämään oman virtualboxini ulkopuolelle komennolla ping 8.8.8.8. Network is unreacheable, joten voin aloittaa tehtävät. Kohteena on jälleen kerran metasploitable 2. Wireshark pyörii Kalissa. Wiresharkkiin tulee jostain syystä udp broadcast paketteja. Suodatin ne pois käyttämällä filtteriä tcp.

# z)

# a) nmap TCP connect scan -sT

Ajoin komennon sudo nmap -sT -p22 192.168.56.101 (viittaan tähän sanalla kohdeIp myöhemmissä kohdissa)

![image](https://user-images.githubusercontent.com/81921071/166102513-ed6c55b8-c7c0-437a-8482-0703b7226b1a.png)

Wiresharkin perusteella nmap muodostaa yhteyden kohdekoneen porttiin 22. Se lähettää normaalin tcp yhteyden avauksen eli SYN > SYN ACK > ACK lipuilla varustetut paketit. Yhteyden avaamisen jälkeen yhteys suljetaan.

Googlasin vielä tietoa, miten -sT valinta toimii. Nmap yrittää avata TCP yhteyden johonkin porttiin. Eli se avaa yhteyden ja kun kohde alkaa lähettää dataa, nmap sulkee yhteyden. TCP scannia käytetään yleensä, kun SYN scannia ei voida tehdä. Tämä scanni lähettää hieman enemmän paketteja kuin SYN scan, mutta niiden määrä ei ole merkittävä.

lähde: https://nmap.org/book/scan-methods-connect-scan.html

# b) nmap TCP SYN "used to be stealth" scan, -sS (tätä käytetään skannatessa useimmin)

Ajoin komennon sudo nmap -sS -p22 kohdeIp

![image](https://user-images.githubusercontent.com/81921071/166117750-3b00c2d6-c495-4b15-ac69-c80d0140bf0e.png)

Tässä scannauksessa yhteys suljetaan heti SYN ACK paketin jälkeen. Tämä on suosituin scannaustapa. SYN scannia sanotaan stealth scanniksi, koska TCP yhteys ei koskaan muodostu kokonaan. nmap tietää portin olevan auki SYN ACK lipuista, joilla kohde vastaa yhteyspyyntöön. SYN scan tarvitsee "Raw packet privileges" eli käytännössään root/admin oikeudet. Tämä perustuu trusted network & hardware oletukseen, joka on unix pohjaisissa järjestelmissä. Eli peruskäyttäjään ei luoteta.

Lähteet: https://nmap.org/book/synscan.html#scan-methods-fig-syn-scan-open

https://security.stackexchange.com/questions/244635/why-do-i-need-root-privileges-to-send-a-raw-packet-from-a-unix-machine

# c) nmap ping sweep -sn

Ajoin komennon nmap -sn 192.168.56.0/24

![image](https://user-images.githubusercontent.com/81921071/166118490-ce57ed8e-b801-4624-9aa5-cc7e9fe8fb25.png)

Tällä komennolla otetaan portti skannaus pois käytöstä ja tehdään pelkkä host discovery. Wiresharkissa näkyy, että nmap tekee ARP kyselyn jokaiselle määritellyn avaruuden ip-osoitteelle. Järjestelmän ylläpitäjälle hyvä työkalu.

lähde: https://nmap.org/book/host-discovery-controls.html#host-discovery-sn

# d) nmap don't ping -Pn

Ajoin komennon sudo nmap -Pn 192.168.0.0/16

Kokeilin huvikseni isompaa avaruutta, mutta nmap ei tietenkään löydä reittiä mihinkään osoitteeseen, paitsi 192.168.56/0/24 osoitteisiin.

![image](https://user-images.githubusercontent.com/81921071/166119899-ddf81f43-ca00-40f5-b719-9e4bee6e3a6e.png)

En ole nyt ihan varma, toimiko tämä komento oikein. Referenssin mukaan tämän pitäisi porttiskannata kaikki osoitteet antamassani avaruudessa.

Idea tässä on siis, että skipataan host discovery osio kokonaan ja yritetään vaan skannata avaruuden osoitteiden portteja. Syy miksi tätä halutaan käyttää on se, että jossain kohteissa saattaa olla host discoveryn estäviä palomuureja tai muita turvajärjestelmiä. Tätä voisi sanoa bruteforce skannaukseksi, koska skannauksessa kestää suhteellisen kauan.

lähde: https://nmap.org/book/host-discovery-controls.html#host-enum-p0

# e) nmap version detection -sV (esimerkki yhdestä palvelusta yhdessä portissa riittää)

Ajoin komennon nmap -sV -p22 kohdeIp

![image](https://user-images.githubusercontent.com/81921071/166118829-45d914df-d97a-44d4-84c0-74122171f09d.png)

![image](https://user-images.githubusercontent.com/81921071/166118977-a0bbc6e9-b21e-4aa0-a9cf-6bfd5a56bbe8.png)

Tässä skannauksessa selvitetään portin takana pyörivän palvelun tiedot ja versio. Eli nmap tunnistaa ensiksi, että portti 22 on auki. Sen jälkeen, nmap avaa uuden yhteyden jossa kohde lähettää tiedot, jotka löytyvät portin takaa. Kuvassa paketti 73. Tämän jälkeen yhteys suljetaan niin sanotusti oikealla tavalla. Eli FIN ACK liput lähetetään kohteelle ja yhteys sulkeutuu.

lähde: https://nmap.org/book/man-version-detection.html

# f) nmap porttien valinta -p1-100, --top-ports 5, -p-

Komento nmap -p1-100 kohdeIp

![image](https://user-images.githubusercontent.com/81921071/166120465-c7d87dd7-5359-43a0-bbce-7c7987411ed7.png)

Tällä komennolla määritellään skannatujen porttien alue(range). Eli tässä tapauksessa 1-100. Käytetty skannaustapa on TCP connect eli käydään koko SYN>SYN ACK>ACK prosessi läpi. 

Komento nmap --top-ports 5 kohdeIp

![image](https://user-images.githubusercontent.com/81921071/166120589-037fd8e7-f530-4065-a2a6-4197f990880c.png)

Komento käy määritellyn määrän (5) verran top ratio portteja läpi nmap-services tiedostossa olevalta listalta. Eli tässä tapauksessa 21 ftp, 22 ssh, 23 telnet, 80 http ja 443 https. Käytetty tapa on taas TCP connect.

Komento nmap -p- kohdeIp

![image](https://user-images.githubusercontent.com/81921071/166120766-4682525e-f6b3-4208-b01b-67ea3ddbff88.png)

Tämä komento käy kaikki portit läpi. Paketteja lähetettin reilu 131000 yhteen kohde ip-osoitteeseen. Tapa on taas TCP connect. Portit, joista ei tule vastausta, ilmoitetaan nmapin tulosteessa conn refused portteina.

lähde: https://nmap.org/book/man-port-specification.html

# g) nmap ip-osoitteiden valinta; luettelo, verkkomaskilla 10.10.10.0/24, alku- ja loppuosoitteella 10.10.10.100-130 (ipcalc auttaa ymmärtämään, miten verkkomaskia tulkitaan)

Komento: sudo nmap -p22 192.168.56.0/24

Komento ajaa skannauksen määritellylle osoiteavaruudelle. Eli tässä tapauksessa avaruus olisi 192.168.56.0-255.

Komento sudo nmap -p22 192.168.56.100-130

Komento ajaa skannauksen määritellyille osoitteille. Tässä tapauksessa osoitteet, jotka päättyvät 100-130, avaruudessa 192.168.56.0/24.

# h) nmap output files -oA foo. Mihin kukin tiedostotyyppi sopii?

Komento: sudo nmap -p22 -oA foo kohdeIp

-oA tarkoittaa output to all formats. Nämä formaatit joihin nmap voi tulostaa ovat normal, XML ja grepable.

Normal tarkoittaa normaalia nmapin tulostetta. Eli sama, mikä tulostuu terminaaliin kun komento on ajettu.

XML tulostaa komennon outputin xml tiedostoon, jonka doctype on nmaprun. Tämä tiedosto on tarkoitettu pääasiassa ohjelmalla lukua varten, mutta sitä voi katsoa myös selaimen kautta muuttamalla doctype nmaprunista html:läksi.

![image](https://user-images.githubusercontent.com/81921071/166121486-5033b139-3473-476a-ae25-03c5a9a4baa7.png)

Grepable tulostaa outputin muotoon, johon voi käyttää grep komentoa tehokkaasti. Esimerkiksi voidaan etsiä "grep open" komennolla kaikki rivit, joissa on avoimia portteja.

![image](https://user-images.githubusercontent.com/81921071/166121677-86cc2aa5-e50c-4c77-9fb7-0911dcbeff0d.png)

Lähde: https://nmap.org/book/man-output.html

# k) nmap ajonaikaiset toiminnot (man nmap: runtime interaction): verbosity v/V, help ?, packet tracing p/P, status s (ja moni muu nappi)

Ajoin komentoa nmap -p- kohdeIp testatakseni eri näppäimiä.

Verbosity tarkoittaa nmapin tulostamien tietojen määrää. v suurentaa määrää, iso V pienentää määrää. Esimerkiksi verbosity 10 tasolla nmap tulostaa rivin aina kun uusi avoin portti on löydetty.

![image](https://user-images.githubusercontent.com/81921071/166121880-04e2450c-6fa4-48f7-9b32-fcb74817362d.png)

Kysymysmerkki ? tulostaa runtime interactions komentojen selitteen.

![image](https://user-images.githubusercontent.com/81921071/166121918-536b8c14-b961-43ea-8045-16cca43ee537.png)

Packet tracing. pieni p laittaa päälle, iso P pois päältä. Tulostaa rivin jokaista pakettia kohden.

![image](https://user-images.githubusercontent.com/81921071/166121988-ebac44e8-7322-46c4-a39c-7724f1436412.png)

Debug. pieni d päälle, iso D pois. Tulostaa debug tietoja.

![image](https://user-images.githubusercontent.com/81921071/166122019-1b97f550-b902-4fa3-9616-928b53291a1d.png)

Tässä kuvassa ilmeisesti suljettujen porttien connection refused timeout aikojen arvoja.

Status. Mikä tahansa muu nappi tulostaa komennon statuksen.

![image](https://user-images.githubusercontent.com/81921071/166122002-4ee34f95-b7b3-4980-ad31-66e76d1f4926.png)

# l) normaalisti 'sudo nmap'. Miten nmap toiminta eroaa, jos sitä ajaa ilman sudoa? Suorita ja analysoi esimerkki.

Yksi eroavaisuus joka näiden tehtävien aikana tuli selvitettyä on se, -sS stealth scan vaatii sudo oikeudet. Stealth scan on sudolla ajettaessa oletus skannaustapa.

![image](https://user-images.githubusercontent.com/81921071/166122363-d47b952b-4f73-4099-b050-2965c8a35df6.png)

Googlasin vielä ja samanlainen selitys löytyi superuser.comista. Siellä myös arvuuteltiin, että nmap voi myös ottaa suoraan tietoja ARP cachesta.

lähde: https://superuser.com/questions/887887/different-behavior-sudo-nmap-vs-just-nmap

# m) nmap, vertaile -sV vs -A kestoa (ja lähetetyn datan määrää jos osaat; time, nethogs, wireshark). Käytä harjoitusmaalina metasploitable2.

Ajoin ensiksi komennon sudo nmap -sV kohdeIp

![image](https://user-images.githubusercontent.com/81921071/166122805-ea76ea09-abdd-4aa4-a937-b588a675da43.png)

Kesto 24.76 sekuntia.

![image](https://user-images.githubusercontent.com/81921071/166122832-499382d1-a1c9-49dd-9b81-22f70ac48199.png)

Pakettien määrä 2551. UDP paketit on filtteröity pois, koska ne eivät liity tähän skannaukseen.

Sitten ajoin komennon sudo nmap -a kohdeIp

![image](https://user-images.githubusercontent.com/81921071/166122898-4ba57d06-3752-4d42-bc17-306beeed76ef.png)

Kesto 35.51 sekuntia, 9 sekuntia hitaampi kuin -sV.

![image](https://user-images.githubusercontent.com/81921071/166122909-2c16fe74-8694-487f-b4ff-913b05b0ab64.png)

Paketteja on 4222, eli noin 1700 enemmän. -A ajaa agressiivisen skannauksen. Eli -sV skannauksen lisäksi OS, script scan -sC ja --traceroute. On selvää, että -A skannaus lähettää enemmän paketteja ja kestää pidempään, koska se skannaa laajemmin kuin pelkkä -sV.

Lähde: https://nmap.org/book/man-misc-options.html

# d) Ninjojen tapaan. Piiloutuuko nmap-skannaus hyvin palvelimelta? Vinkkejä: Asenna Apache. Aja nmap-versioskannaus -sV omaan paikalliseen weppipalvelimeen. Etsi Apachen lokista tätä koskevat rivit. Wiresharkissa "http" on kätevä filtteri, se tulee siihen yläreunan "Apply a display filter..." -kenttään. Nmap-ajon aikana p laittaa packet tracing päälle. Vapaaehtoinen lisäkohta: jääkö Apachen lokiin jokin todiste nmap-versioskannauksesta?

Asensin omaksi harjoitusmaalikseni uuden virtualbox virtuaalikoneen. Käyttiksenä toimii Ubuntu server 22.04 lts. Tämä julkaistiin ilmeisesti hieman yli viikko sitten.

Asensin apache kakkosen serverille.

![image](https://user-images.githubusercontent.com/81921071/166123942-04d8b91f-2258-4a46-9764-aba80482eceb.png)

Ajoin komennon nmap -sV 192.168.56.103. 2 porttia oli auki, ssh jonka asensin serverille, sekä http. Eli portit 22 ja 80. Sitten tutkimaan apachen logeja.

Apachen logit löytyvät kansiosta /var/log/apache2. Menin katsomaan access.log tiedostoa.

![image](https://user-images.githubusercontent.com/81921071/166124183-81b220f1-a40e-4343-a5a0-c6a232ded0d1.png)

Logeista löytyy viitteitä nmap skannauksesta. GET /nmaplowercheck ja Nmap scripting engine viittaavat siihen, että kohdetta on skannattu nmapilla. Wireshark on myös tallentanut nämä paketit Kalissa.

![image](https://user-images.githubusercontent.com/81921071/166124335-113651b0-0a7f-4200-b7ba-bad800b2a4e8.png)

